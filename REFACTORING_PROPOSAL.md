# リファクタリング提案: NCDC Frontend Challenge

コードベースを確認し、データの整合性に関わる重要な問題から、コードの整理に関するものまで、いくつかの改善点を特定しました。

## 🚨 重大な問題 (高優先度)

### 1. **更新時の競合状態 (データの整合性)**

- **問題**: `src/actions/form-action.ts` の `updateContentTitle` と `updateContentBody` は、「読み取り(Read) → 変更(Modify) → 書き込み(Write)」のパターンになっています。
  1. `getContent(id)` (現在の状態を取得)
  2. 新しいタイトルまたは本文をマージ
  3. `updateContent(id, ...)` (新しい状態を保存)
- **リスク**: ユーザー A が「タイトル」を更新し、ユーザー B が「本文」を同時に更新した場合：
  - A が取得 (タイトル:旧, 本文:旧)
  - B が取得 (タイトル:旧, 本文:旧)
  - A が保存 (タイトル:**新**, 本文:旧)
  - B が保存 (タイトル:旧, 本文:**新**) → **A のタイトルの変更が、B の保存によって古い値で上書きされ、失われます。**
- **解決案**:
  - **理想**: バックエンドが PATCH リクエスト（部分更新）に対応すること。
  - **フロントエンドでの対応**: バックエンドが `version` フィールドを持っていれば楽観的ロックが可能ですが、現状ではこのリスクを認識しておくか、ロック機構が必要です。

### 2. **エラーハンドリングの問題**

- **問題**: `src/actions/content.ts` 内で、`try-catch` ブロックが特定のエラーを捕捉した後、一般的な文字列のエラー（例：「コンテンツの取得に失敗しました」）として投げ直しています。
- **影響**: これにより、元のスタックトレースや詳細なエラー情報（404 以外のステータスコードなど）が失われ、デバッグが困難になります。
- **解決案**: カスタムエラークラスを作成するか、元のエラー情報を含めた状態で再スローするように修正すべきです。

### 3. **Server Action のデータの安全性**

- **問題**: `FormData` からのデータ抽出が手動で行われており、型安全性が弱いです。
- **解決案**: `zod-form-data` や `conform` の機能を使い、`FormData` から直接バリデーションを行うことを推奨します。

## 🛠 設計面の改善 (中優先度)

### 4. **フックのロジック重複 (DRY 原則)**

- **問題**: `use-title-editor.ts` と `use-body-editor.ts` は、編集モードの切り替え、フォーム送信、エラーハンドリングなど、ロジックの 9 割が共通していると思われます。
- **解決案**: `useContentFieldEditor` のような汎用的なフックを作成し、共通ロジックを切り出すべきです。

### 5. **Actions の責務分離**

- **問題**: `src/actions/content.ts` が DTO の型定義とドメインロジックを混在させています。
- **解決案**: 現状は許容範囲ですが、アプリが成長した場合は分離を検討すべきです。

## 🎨 UI/UX とコード品質 (低優先度/品質向上)

### 6. **ハードコードされた文字列**

- **問題**: "無題" や "これはダミーデータです" といった文字列がコード内に直接書かれています。
- **解決案**: 定数ファイル (`src/config/constants.ts` など) に移動させるべきです。

## 次のステップ

**フックのリファクタリング** (項目 4) と **エラーハンドリングの改善** (項目 2) は、フロントエンドだけで完結し、かつ効果が高いため、これらを優先して対応することをお勧めします。

**競合状態** (項目 1) は深刻ですが、根本的な解決にはバックエンドの改修が必要になる可能性があります。
